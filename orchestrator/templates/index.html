<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Docker Arena Prototype</title>
    <style>
        body {
            font-family: monospace;
            background: #0d1117;
            color: #c9d1d9;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 {
            margin-bottom: 20px;
        }

        #arena {
            display: grid;
            grid-template-columns: repeat(6, 60px) !important;
            grid-gap: 5px;
            max-width: 390px;
            /* (60+5)*6 roughly */
            margin: 0 auto;
        }

        .node {
            width: 60px;
            height: 60px;
            background: #161b22;
            border: 1px solid #30363d;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .node .id {
            font-size: 0.6em;
            color: #8b949e;
        }

        .node.active {
            border-color: #58a6ff;
            box-shadow: 0 0 5px #58a6ff44;
        }

        .gladiator {
            width: 40px;
            height: 40px;
            background: #238636;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            z-index: 10;
        }

        .gladiator.enemy {
            background: #da3633;
        }

        .gladiator.spartacus {
            background: #bf39d6;
            border: 2px solid #ffd700;
            box-shadow: 0 0 5px #bf39d6;
            font-size: 0.6em;
        }

        .gladiator.blue-team {
            background: #007bff !important;
            border: 1px solid #ffffff !important;
            box-shadow: 0 0 10px #007bff !important;
            font-size: 0.6em;
        }

        .gladiator.red-team {
            background: #da3633 !important;
            border: 1px solid #ffffff !important;
            box-shadow: 0 0 10px #da3633 !important;
            font-size: 0.6em;
        }

        #scoreboard {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            font-size: 1.2em;
            font-weight: bold;
            background: #161b22;
            padding: 10px 20px;
            border: 1px solid #30363d;
            border-radius: 8px;
        }

        .score-red {
            color: #da3633;
        }

        .score-blue {
            color: #58a6ff;
        }
    </style>
</head>

<body>

    <div id="container" style="display: flex; flex-direction: row; gap: 20px;">
        <div id="arena-container">
            <h1>Arena Visualizer V5: TIGHT GRID</h1>
            <div id="scoreboard">
                <div class="score-red">RED: <span id="score-red">0</span></div>
                <div class="score-blue">BLUE: <span id="score-blue">0</span></div>
            </div>
            <div id="status">Loading...</div>
            <div id="arena"></div>
        </div>
        <div id="logs-container"
            style="width: 300px; background: #161b22; border: 1px solid #30363d; padding: 10px; height: 600px; display: flex; flex-direction: column;">
            <div id="objectives-panel"
                style="margin-bottom: 15px; border-bottom: 2px solid #30363d; padding-bottom: 10px; flex-shrink: 0;">
                <h3 style="margin-top: 0; color: #ffd700;">ðŸ“¡ Active Objectives</h3>
                <div id="active-tasks">Waiting for data...</div>
            </div>
            <div id="feed-container" style="flex-grow: 1; overflow-y: auto;">
                <h3 style="margin-top: 0;">ðŸ“œ Live Feed</h3>
                <div id="logs">Waiting for updates...</div>
            </div>
        </div>
    </div>

    <script>
        async function fetchGrid() {
            const statusDiv = document.getElementById('status');
            try {
                // Use random query param to bust cache
                const res = await fetch('/api/grid?t=' + Date.now());
                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                const data = await res.json();
                console.log("DEBUG: API Response:", data); // Explicit Debug Log

                // Handle new wrapper format { grid: ..., logs: ... } 
                const gridData = data.grid || data;
                const logData = data.logs || {};
                const keyLoc = data.key_location;
                console.log("DEBUG: keyLoc extracted:", keyLoc);

                statusDiv.innerText = `Connected. Grid Size: ${Object.keys(gridData).length} nodes`;
                renderGrid(gridData, keyLoc);
                renderLogs(logData, data);
                renderScores(data.scores || { RED: 0, BLUE: 0 });
            } catch (e) {
                console.error("Error fetching grid:", e);
                statusDiv.innerText = `Error: ${e.message}`;
                statusDiv.style.color = 'red';
            }
        }

        function renderScores(scores) {
            document.getElementById('score-red').innerText = scores.RED || 0;
            document.getElementById('score-blue').innerText = scores.BLUE || 0;
        }

        async function fetchStats() {
            try {
                const res = await fetch('/api/grid'); // This contains logs and stats sometimes?
                // Actually, the main grid fetch is fine.
            } catch (e) { }
        }

        function renderLogs(logs, data) {
            const feedDiv = document.getElementById('logs');
            const tasksDiv = document.getElementById('active-tasks');

            if (Object.keys(logs).length === 0) {
                feedDiv.innerHTML = "<i>No activity...</i>";
                tasksDiv.innerHTML = "<i>No active gladiators...</i>";
                return;
            }

            // 1. Unified Active Objectives (Pinned)
            let tasksHtml = "";
            let allMessages = [];

            for (const [id, messages] of Object.entries(logs)) {
                // Get latest status for objective panel
                const currentStatus = messages.slice().reverse().find(m => m.startsWith("STATUS:"));
                if (currentStatus) {
                    const cleanStatus = currentStatus.replace(/\[.*\]\sSTATUS:\s/, "").replace("STATUS: ", "");
                    const teamColor = id.includes("RED") ? "#da3633" : "#58a6ff";

                    // Mastery & XP details
                    const stats = data.gladiators?.[id] || {};
                    const mastery = stats.mastery_level || 1;
                    const xp = stats.xp || 0;

                    tasksHtml += `<div style="font-size: 0.85em; margin-bottom: 8px; color: #ffd700; font-weight: bold; background: #21262d; padding: 6px 10px; border-radius: 4px; border-left: 4px solid ${teamColor};">
                        <div style="font-size: 0.7em; color: ${teamColor}; display: flex; justify-content: space-between; margin-bottom: 2px; text-transform: uppercase;">
                            <span>${id}</span>
                            <span>Level ${mastery}</span>
                        </div>
                        <div style="width: 100%; height: 3px; background: #30363d; margin-bottom: 5px;">
                            <div style="width: ${xp}%; height: 100%; background: ${teamColor};"></div>
                        </div>
                        ${cleanStatus}
                    </div>`;
                }

                // Collect all other logs for unified feed
                messages.forEach(m => {
                    if (m.includes("STATUS:")) return;
                    allMessages.push({ id, text: m });
                });
            }

            // 2. Sort Unified History by Timestamp
            allMessages.sort((a, b) => {
                const tsA = a.text.match(/\[(.*?)\]/)?.[1] || "";
                const tsB = b.text.match(/\[(.*?)\]/)?.[1] || "";
                return tsA.localeCompare(tsB);
            });

            // 3. Render Unified History (Last 50 entries)
            let historyHtml = allMessages.slice(-50).map(m => {
                const teamColor = m.id.includes("RED") ? "#da3633" : "#58a6ff";
                const shortId = m.id.split('_').slice(0, 2).join('_');
                return `<div style="font-size: 0.8em; margin-bottom: 3px; color: #8b949e; line-height: 1.2;">
                    <span style="color: ${teamColor}; font-weight: bold;">${shortId}</span> ${m.text}
                </div>`;
            }).join("");

            tasksDiv.innerHTML = tasksHtml || "<i>Awaiting mission data...</i>";
            feedDiv.innerHTML = historyHtml;

            // 3. Auto-scroll history container
            const container = document.getElementById('feed-container');
            container.scrollTop = container.scrollHeight;
        }

        function renderGrid(data, keyLocation) {
            const arena = document.getElementById('arena');
            arena.innerHTML = '';

            let maxX = 0;
            let maxY = 0;
            Object.keys(data).forEach(k => {
                const parts = k.split(',');
                if (parts.length === 2) {
                    maxX = Math.max(maxX, parseInt(parts[0]));
                    maxY = Math.max(maxY, parseInt(parts[1]));
                }
            });
            const cols = maxX + 1;
            const rows = maxY + 1;

            arena.style.gridTemplateColumns = `repeat(${cols}, 60px)`;

            for (let y = 0; y < rows; y++) {
                for (let x = 0; x < cols; x++) {
                    const key = `${x},${y}`;
                    const cell = data[key];

                    const nodeDiv = document.createElement('div');
                    nodeDiv.className = 'node';
                    nodeDiv.innerHTML = `<span class="id">${x},${y}</span>`;

                    if (cell) {
                        if (cell.gladiator) {
                            const gladDiv = document.createElement('div');
                            gladDiv.className = 'gladiator';

                            let gladName = cell.gladiator.toUpperCase();
                            if (gladName.includes('BLUE')) {
                                gladDiv.classList.add('blue-team');
                                gladDiv.innerText = 'BLUE';
                            } else if (gladName.includes('RED')) {
                                gladDiv.classList.add('red-team');
                                gladDiv.innerText = 'RED';
                            } else if (gladName === 'SPARTACUS') {
                                gladDiv.classList.add('spartacus');
                                gladDiv.innerText = 'SPART';
                            } else {
                                if (cell.gladiator !== 'Glad_A') gladDiv.classList.add('enemy');
                                gladDiv.innerText = cell.gladiator.substring(0, 2);
                            }

                            nodeDiv.appendChild(gladDiv);
                            nodeDiv.classList.add('active');

                            // Highlight host container logic?
                            if (cell.id.includes(cell.gladiator)) {
                                // ?
                            }
                        }
                    } else {
                        nodeDiv.style.opacity = '0.5';
                        nodeDiv.innerText += ' (Offline)';
                    }

                    // Highlight key location if present
                    if (keyLocation === key) {
                        const keyIndicator = document.createElement('div');
                        keyIndicator.innerText = 'KEY';
                        keyIndicator.style.position = 'absolute';
                        keyIndicator.style.top = '5px';
                        keyIndicator.style.right = '5px';
                        keyIndicator.style.fontSize = '0.7em';
                        keyIndicator.style.color = '#ffeb3b';
                        keyIndicator.style.fontWeight = 'bold';
                        nodeDiv.appendChild(keyIndicator);
                    }

                    arena.appendChild(nodeDiv);
                }
            }
        }

        setInterval(fetchGrid, 1000);
        fetchGrid();
    </script>
</body>

</html>